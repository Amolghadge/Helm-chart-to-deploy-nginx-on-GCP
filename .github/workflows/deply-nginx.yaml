name: Deploy NGINX to GKE
on:
  push:
    branches: [ main, develop ]
    paths:
      - 'helm-chart/**'
      - '.github/workflows/deploy-nginx.yml'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER: nginx-cluster
  GKE_ZONE: ${{ secrets.GCP_ZONE }}
  DEPLOYMENT_NAME: nginx
  IMAGE: nginx
  HELM_CHART_PATH: './helm-chart'

jobs:
  setup-build-publish-deploy:
    name: Setup, Build, Publish, and Deploy
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
          
        # Set the project
          gcloud config set project $PROJECT_ID

      - name: Install gke-gcloud-auth-plugin
        run: |
          sudo apt-get update
          sudo apt-get install -y google-cloud-sdk-gke-gcloud-auth-plugin
          gke-gcloud-auth-plugin --version

      - name: Configure gcloud and kubectl
        run: |
          gcloud config set project $PROJECT_ID
          gcloud container clusters get-credentials "$GKE_CLUSTER" \
            --zone "$GKE_ZONE" \
            --project "$PROJECT_ID"
          kubectl cluster-info

          
          # Verify the kubeconfig doesn't use the plugin
          cat ~/.kube/config
          
          # Test connection
          kubectl cluster-info

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.14.4'

      - name: Validate Helm Chart
        run: |
          helm lint $HELM_CHART_PATH
          helm template $DEPLOYMENT_NAME $HELM_CHART_PATH --dry-run

      - name: Deploy to GKE
        run: |
          # Ensure we're using traditional auth
          export USE_GKE_GCLOUD_AUTH_PLUGIN=False
          
          # Refresh credentials
          gcloud container clusters get-credentials "$GKE_CLUSTER" \
            --zone "$GKE_ZONE" \
            --project "$PROJECT_ID"
          
          # Verify connection
          kubectl get nodes
          
          # Deploy with Helm
          helm upgrade --install $DEPLOYMENT_NAME $HELM_CHART_PATH \
            --namespace default \
            --create-namespace \
            --wait \
            --timeout=300s \
            --debug

      - name: Verify deployment
        run: |
          kubectl rollout status deployment/$DEPLOYMENT_NAME --timeout=300s
          echo "=== Services ==="
          kubectl get services -o wide
          echo "=== Pods ==="
          kubectl get pods -o wide
          echo "=== Deployments ==="
          kubectl get deployments -o wide
          echo "=== Ingress (if enabled) ==="
          kubectl get ingress -o wide || echo "No ingress found"
