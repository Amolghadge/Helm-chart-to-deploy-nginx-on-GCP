name: Deploy Nginx to GKE

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allow manual triggers

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER: nginx-cluster
  GKE_ZONE: ${{ secrets.GKE_ZONE || 'us-central1-c' }}
  DEPLOYMENT_NAME: nginx
  HELM_CHART_DIR: ./helm-chart
  NAMESPACE: default

jobs:
  deploy:
    name: Deploy Nginx to GKE
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}
        service_account_key: ${{ secrets.GCP_SA_KEY }}
        export_default_credentials: true

    - name: Configure Docker
      run: gcloud auth configure-docker --quiet

    - name: Verify GKE cluster exists
      run: |
        echo "Verifying GKE cluster: $GKE_CLUSTER in zone: $GKE_ZONE"
        gcloud container clusters describe $GKE_CLUSTER \
          --zone $GKE_ZONE \
          --project $PROJECT_ID
        
        echo "‚úÖ Cluster verification successful"

    - name: Get GKE credentials
      uses: google-github-actions/get-gke-credentials@v2
      with:
        cluster_name: ${{ env.GKE_CLUSTER }}
        location: ${{ env.GKE_ZONE }}
        project_id: ${{ env.PROJECT_ID }}

    - name: Verify cluster connection
      run: |
        kubectl cluster-info
        echo "=== Cluster Nodes ==="
        kubectl get nodes
        echo "=== Current Deployments ==="
        kubectl get deployments --all-namespaces

    - name: Setup Helm
      uses: azure/setup-helm@v3
      with:
        version: '3.12.0'

    - name: Add Helm repositories
      run: helm repo add bitnami https://charts.bitnami.com/bitnami

    - name: Update Helm repositories
      run: helm repo update

    - name: Validate Helm chart
      run: |
        echo "=== Linting Helm chart ==="
        helm lint $HELM_CHART_DIR
        
        echo "=== Template validation ==="
        helm template $DEPLOYMENT_NAME $HELM_CHART_DIR --namespace $NAMESPACE --debug

    - name: Deploy Nginx using Helm
      run: |
        echo "Deploying Nginx Helm chart to GKE cluster..."
        
        helm upgrade --install $DEPLOYMENT_NAME $HELM_CHART_DIR \
          --namespace $NAMESPACE \
          --create-namespace \
          --set replicaCount=3 \
          --set image.repository=nginx \
          --set image.tag="1.25.3" \
          --set image.pullPolicy=IfNotPresent \
          --set service.type=LoadBalancer \
          --set service.port=80 \
          --set service.targetPort=8080 \
          --set resources.requests.cpu=250m \
          --set resources.requests.memory=256Mi \
          --set resources.limits.cpu=500m \
          --set resources.limits.memory=512Mi \
          --set securityContext.runAsNonRoot=true \
          --set securityContext.runAsUser=1000 \
          --set podSecurityContext.fsGroup=2000 \
          --wait \
          --timeout 10m \
          --atomic

    - name: Verify deployment
      run: |
        echo "=== Deployment status ==="
        kubectl get deployments -n $NAMESPACE
        
        echo "=== Pods status ==="
        kubectl get pods -n $NAMESPACE -l "app.kubernetes.io/name=nginx"
        
        echo "=== Services ==="
        kubectl get services -n $NAMESPACE
        
        echo "=== Waiting for pods to be ready ==="
        kubectl wait --for=condition=ready pod -l "app.kubernetes.io/name=nginx" -n $NAMESPACE --timeout=300s
        
        echo "‚úÖ Deployment verification completed"

    - name: Get application endpoints
      run: |
        echo "=== Application Details ==="
        
        # Get LoadBalancer IP
        EXTERNAL_IP=$(kubectl get service $DEPLOYMENT_NAME -n $NAMESPACE -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
        
        if [ -n "$EXTERNAL_IP" ]; then
          echo "üéâ Nginx is now accessible at: http://$EXTERNAL_IP"
          echo "üåê Health endpoint: http://$EXTERNAL_IP/health"
          echo "üìä Main endpoint: http://$EXTERNAL_IP/"
        else
          echo "‚è≥ LoadBalancer IP is being provisioned..."
          echo "You can check the status with: kubectl get service $DEPLOYMENT_NAME -n $NAMESPACE -w"
        fi

    - name: Run health checks
      run: |
        echo "Running health checks..."
        
        # Wait for LoadBalancer to be ready
        sleep 30
        
        EXTERNAL_IP=$(kubectl get service $DEPLOYMENT_NAME -n $NAMESPACE -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
        
        if [ -n "$EXTERNAL_IP" ]; then
          echo "Testing Nginx service at http://$EXTERNAL_IP"
          
          # Test with retries
          for i in {1..12}; do
            echo "Health check attempt $i/12..."
            if curl -f -s -m 10 http://$EXTERNAL_IP/health; then
              echo "‚úÖ Health check passed!"
              break
            else
              if [ $i -eq 12 ]; then
                echo "‚ùå Health check failed after 12 attempts"
                exit 1
              fi
              sleep 10
            fi
          done
          
          # Test main endpoint
          curl -f -s -m 10 http://$EXTERNAL_IP/ || echo "‚ö†Ô∏è Main endpoint check failed (might be expected for empty root)"
        else
          echo "‚ÑπÔ∏è Skipping health checks - no external IP yet"
        fi

    - name: Display deployment information
      run: |
        echo "=== Deployment Summary ==="
        echo "Cluster: $GKE_CLUSTER"
        echo "Zone: $GKE_ZONE"
        echo "Namespace: $NAMESPACE"
        echo "Application: $DEPLOYMENT_NAME"
        echo "Chart: $HELM_CHART_DIR"
        
        # Get detailed service info
        kubectl describe service $DEPLOYMENT_NAME -n $NAMESPACE | grep -E "(Name:|Namespace:|Labels:|Annotations:|IP:|Port:)" || true

  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    if: failure() && needs.deploy.result == 'failure'
    needs: deploy
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}
        service_account_key: ${{ secrets.GCP_SA_KEY }}
        export_default_credentials: true

    - name: Get GKE credentials
      uses: google-github-actions/get-gke-credentials@v2
      with:
        cluster_name: ${{ env.GKE_CLUSTER }}
        location: ${{ env.GKE_ZONE }}
        project_id: ${{ env.PROJECT_ID }}

    - name: Setup Helm
      uses: azure/setup-helm@v3

    - name: Check deployment history
      run: |
        echo "=== Deployment History ==="
        helm history $DEPLOYMENT_NAME --namespace $NAMESPACE || true

    - name: Rollback deployment
      run: |
        if helm history $DEPLOYMENT_NAME --namespace $NAMESPACE 2>/dev/null | grep -q "FAILED"; then
          echo "üö® Rolling back deployment..."
          helm rollback $DEPLOYMENT_NAME 0 --namespace $NAMESPACE --wait --timeout 5m
          echo "‚úÖ Rollback completed successfully"
        else
          echo "‚ÑπÔ∏è No failed deployment found to rollback"
        fi

    - name: Debug information
      run: |
        echo "=== Debug Information ==="
        echo "Pods:"
        kubectl get pods -n $NAMESPACE || true
        echo "Services:"
        kubectl get services -n $NAMESPACE || true
        echo "Events:"
        kubectl get events -n $NAMESPACE --sort-by='.lastTimestamp' | tail -20 || true
