name: Deploy NGINX to GKE
on:
  push:
    branches: [ main, develop ]
    paths:
      - 'helm-chart/**'
      - '.github/workflows/deploy-nginx.yml'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER: nginx-cluster
  GKE_ZONE: ${{ secrets.GCP_ZONE }}
  DEPLOYMENT_NAME: nginx
  IMAGE: nginx
  HELM_CHART_PATH: ./helm-chart
  USE_GKE_GCLOUD_AUTH_PLUGIN: 'True'

jobs:
  setup-build-publish-deploy:
    name: Setup, Build, Publish, and Deploy
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
          install_components: 'gke-gcloud-auth-plugin'

      - name: Configure Docker and Kubectl to use gke-gcloud-auth-plugin
        run: |
          gcloud --version
          which gke-gcloud-auth-plugin
          gke-gcloud-auth-plugin --version
          echo "GKE auth plugin installed successfully"

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Configure GKE credentials
        run: |
          # Set project
          gcloud config set project $PROJECT_ID
          
          # Get GKE credentials with explicit plugin configuration
          gcloud container clusters get-credentials "$GKE_CLUSTER" \
            --zone "$GKE_ZONE" \
            --project "$PROJECT_ID"
          
          # Update kubeconfig to use the plugin
          kubectl config view
          
          # Test connection
          kubectl cluster-info

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.14.4'

      - name: Validate Helm Chart
        run: |
          helm lint $HELM_CHART_PATH
          helm template $DEPLOYMENT_NAME $HELM_CHART_PATH --dry-run

      - name: Deploy to GKE
        run: |
          # Set project
          gcloud config set project $PROJECT_ID
          
          # Refresh GKE credentials
          gcloud container clusters get-credentials "$GKE_CLUSTER" \
            --zone "$GKE_ZONE" \
            --project "$PROJECT_ID"
          
          # Verify connection
          kubectl get nodes
          
          # Deploy with Helm
          helm upgrade --install $DEPLOYMENT_NAME $HELM_CHART_PATH \
            --namespace default \
            --create-namespace \
            --wait \
            --timeout=300s \
            --debug

      - name: Verify deployment
        run: |
          kubectl rollout status deployment/$DEPLOYMENT_NAME --timeout=300s
          echo "=== Services ==="
          kubectl get services -o wide
          echo "=== Pods ==="
          kubectl get pods -o wide
          echo "=== Deployments ==="
          kubectl get deployments -o wide
          echo "=== Ingress (if enabled) ==="
          kubectl get ingress -o wide || echo "No ingress found"
